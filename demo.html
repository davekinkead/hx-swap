<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HX-SWAP Extension Demo</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="hx-swap.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        header {
            background: #333;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
        }
        main {
            background: #f4f4f4;
            padding: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .cart {
            background: #ff6b6b;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
        }
        .counter {
            background: #4ecdc4;
            padding: 2px 8px;
            border-radius: 3px;
            font-weight: bold;
        }
        .example {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        h2 {
            margin-top: 0;
        }
        .status {
            background: #ffe66d;
            padding: 2px 8px;
            border-radius: 3px;
        }
    </style>
</head>
<body hx-ext="hx-swap-ids">

    <h1>HX-SWAP Extension Demo</h1>
    <p>This demo shows the <code>hx-swap="ids"</code> extension in action.</p>

    <div class="example">
        <h2>Example 1: Basic Cart Update (from README)</h2>
        <header>
            <div>Shopping Cart: <span id="cart" class="cart">0</span> items</div>
        </header>
        <main>
            <p>The cart count is <span id="counter" class="counter">0</span></p>
            <button
                hx-post="/api/update-cart"
                hx-swap="ids"
                onclick="mockCartUpdate(event)">
                Add to Cart
            </button>
        </main>
    </div>

    <div class="example">
        <h2>Example 2: Multiple Updates</h2>
        <div>
            <p>User: <span id="username" class="status">Guest</span></p>
            <p>Status: <span id="user-status" class="status">Offline</span></p>
            <p>Last Login: <span id="last-login" class="status">Never</span></p>
            <button
                hx-post="/api/login"
                hx-swap="ids"
                onclick="mockLogin(event)">
                Login
            </button>
        </div>
    </div>

    <div class="example">
        <h2>Example 3: Nested IDs (Only Outermost Replaced)</h2>
        <div id="outer-container" style="border: 2px solid blue; padding: 10px;">
            <h3>Outer Container</h3>
            <div id="inner-item" style="border: 2px solid green; padding: 10px;">
                Inner Item: <span id="nested-counter" class="counter">0</span>
            </div>
        </div>
        <button
            hx-post="/api/update-nested"
            hx-swap="ids"
            onclick="mockNestedUpdate(event)">
            Update Nested (Only Outer Should Change)
        </button>
    </div>

    <div class="example">
        <h2>Example 4: Duplicate IDs (All Replaced)</h2>
        <p>First counter: <span id="dup-counter" class="counter">0</span></p>
        <p>Second counter: <span id="dup-counter" class="counter">0</span></p>
        <p>Third counter: <span id="dup-counter" class="counter">0</span></p>
        <button
            hx-post="/api/update-duplicates"
            hx-swap="ids"
            onclick="mockDuplicateUpdate(event)">
            Update All Duplicates
        </button>
    </div>

    <script>
        // Mock server responses
        let cartCount = 0;
        let nestedCount = 0;
        let dupCount = 0;

        function mockCartUpdate(event) {
            event.preventDefault();
            cartCount++;

            // Simulate server response
            setTimeout(() => {
                const response = `
                    <body>
                        <span id="cart" class="cart">${cartCount}</span>
                        <span id="counter" class="counter">${cartCount}</span>
                    </body>
                `;

                // Manually trigger HTMX swap for demo purposes
                const button = event.target;
                htmx.ajax('POST', '/api/update-cart', {
                    source: button,
                    swap: 'ids',
                    values: {},
                    target: button
                }).then(() => {
                    // This won't work with mock, so we'll handle it differently
                });
            }, 100);

            // Direct swap for demo
            document.getElementById('cart').textContent = cartCount;
            document.getElementById('counter').textContent = cartCount;
        }

        function mockLogin(event) {
            event.preventDefault();
            document.getElementById('username').textContent = 'JohnDoe';
            document.getElementById('user-status').textContent = 'Online';
            document.getElementById('last-login').textContent = new Date().toLocaleString();
        }

        function mockNestedUpdate(event) {
            event.preventDefault();
            nestedCount++;

            // Update the outer container (which contains inner-item)
            const outer = document.getElementById('outer-container');
            outer.innerHTML = `
                <h3>Outer Container (Updated ${nestedCount})</h3>
                <div id="inner-item" style="border: 2px solid green; padding: 10px;">
                    Inner Item (Updated): <span id="nested-counter" class="counter">${nestedCount}</span>
                </div>
            `;
        }

        function mockDuplicateUpdate(event) {
            event.preventDefault();
            dupCount++;

            const elements = document.querySelectorAll('#dup-counter');
            elements.forEach(el => {
                el.textContent = dupCount;
            });
        }

        // Better approach: Use htmx:configRequest to intercept and mock responses
        document.body.addEventListener('htmx:configRequest', function(event) {
            event.preventDefault();

            const path = event.detail.path;
            let responseHTML = '';

            if (path === '/api/update-cart') {
                cartCount++;
                responseHTML = `
                    <body>
                        <span id="cart" class="cart">${cartCount}</span>
                        <span id="counter" class="counter">${cartCount}</span>
                    </body>
                `;
            } else if (path === '/api/login') {
                responseHTML = `
                    <body>
                        <span id="username" class="status">JohnDoe</span>
                        <span id="user-status" class="status">Online</span>
                        <span id="last-login" class="status">${new Date().toLocaleString()}</span>
                    </body>
                `;
            } else if (path === '/api/update-nested') {
                nestedCount++;
                responseHTML = `
                    <body>
                        <div id="outer-container" style="border: 2px solid red; padding: 10px;">
                            <h3>Outer Container (Updated ${nestedCount} times)</h3>
                            <div id="inner-item" style="border: 2px solid green; padding: 10px;">
                                Inner Item: <span id="nested-counter" class="counter">999</span>
                            </div>
                            <p>The inner-item ID was in the response but nested, so only outer-container replaced!</p>
                        </div>
                    </body>
                `;
            } else if (path === '/api/update-duplicates') {
                dupCount++;
                responseHTML = `
                    <body>
                        <span id="dup-counter" class="counter">${dupCount}</span>
                    </body>
                `;
            }

            // Create a mock XHR response
            const mockXHR = {
                responseText: responseHTML,
                status: 200,
                getResponseHeader: () => null
            };

            // Trigger the response event
            event.detail.target.dispatchEvent(new CustomEvent('htmx:beforeSwap', {
                detail: {
                    xhr: mockXHR,
                    target: event.detail.target,
                    requestConfig: event.detail,
                    shouldSwap: true,
                    serverResponse: responseHTML
                }
            }));
        });

        // Handle the swap
        document.body.addEventListener('htmx:beforeSwap', function(event) {
            if (event.detail.requestConfig && event.detail.serverResponse) {
                const swapStyle = event.detail.target.getAttribute('hx-swap');

                if (swapStyle === 'ids') {
                    event.preventDefault();

                    // Use our extension's swap logic
                    const ext = htmx.config.extensions['hx-swap-ids'];
                    if (ext && ext.handleSwap) {
                        ext.handleSwap('ids', event.detail.target, event.detail.serverResponse, {});
                    }
                }
            }
        });
    </script>

</body>
</html>
